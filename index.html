<!DOCTYPE html>
<html>
  <head>
    <title>我的第一個 WebAR</title>
    <style>
      #pronounce_button {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        padding: 10px 20px;
        font-size: 18px;
        border: none;
        border-radius: 5px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
      }
    </style>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  </head>
  <body style="margin: 0px; overflow: hidden">
    <a-scene embedded arjs="trackingMethod: best; sourceType: webcam">
      <a-assets id="a-assets"> </a-assets>

      <a-entity id="ar-markers"></a-entity>

      <a-entity camera></a-entity>
    </a-scene>

    <button id="pronounce_button">發音</button>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const arMarkersContainer = document.querySelector("#ar-markers");
        const aAssets = document.querySelector("#a-assets");
        const pronounceButton = document.querySelector("#pronounce_button");
        let currentAudio = null;

        const response = await fetch("./data.json");
        const cardData = await response.json();

        cardData.forEach(async (card) => {
          const audioEl = document.createElement("audio");
          audioEl.setAttribute("id", `audio-${card.cardId}`);
          audioEl.setAttribute("src", card.audioPath);
          audioEl.setAttribute("preload", "auto");
          aAssets.appendChild(audioEl);

          const markerEl = document.createElement("a-marker");
          markerEl.setAttribute("type", "pattern");
          markerEl.setAttribute("url", `./Marker/pattern-${card.cardId}.patt`);

          const modelEl = document.createElement("a-gltf-model");
          modelEl.setAttribute("id", `model-${card.cardId}`);
          modelEl.setAttribute("src", card.modelPath);
          modelEl.setAttribute("position", "0 0 0");
          modelEl.setAttribute("scale", card.scale);
          modelEl.setAttribute("rotation", "0 0 0");

          const textEl = document.createElement("a-text");
          textEl.setAttribute("value", card.countryName);
          textEl.setAttribute("position", "0 1.5 0");
          textEl.setAttribute("color", "#333");
          textEl.setAttribute("align", "center");

          markerEl.appendChild(modelEl);
          markerEl.appendChild(textEl);
          arMarkersContainer.appendChild(markerEl);

          markerEl.addEventListener("markerFound", () => {
            currentAudio = document.querySelector(`#audio-${card.cardId}`);
          });

          markerEl.addEventListener("markerLost", () => {
            if (currentAudio) {
              currentAudio.pause();
              currentAudio.currentTime = 0;
              currentAudio = null;
            }
          });
        });

        pronounceButton.addEventListener("click", () => {
          if (currentAudio) {
            currentAudio.load();
            currentAudio.play();
          }
        });
      });
    </script>
  </body>
</html>
